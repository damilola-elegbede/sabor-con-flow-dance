name: Test Suite

on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened, ready_for_review]
  push:
    branches: [ feature/*, develop ]

env:
  PYTHON_VERSION: '3.12'
  NODE_VERSION: '20'

jobs:
  # Quick lint and format check
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install black isort flake8 bandit safety
          pip install -r requirements.txt
      
      - name: Install Node.js dependencies
        run: npm ci
      
      - name: Python code formatting check
        run: |
          echo "=== Black Formatting Check ==="
          black --check --diff core/ sabor_con_flow/
          
          echo "=== Import Sorting Check ==="
          isort --check-only --diff core/ sabor_con_flow/
      
      - name: Python linting
        run: |
          echo "=== Flake8 Linting ==="
          flake8 core/ sabor_con_flow/ --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 core/ sabor_con_flow/ --count --max-complexity=10 --max-line-length=88 --statistics
      
      - name: JavaScript linting
        run: |
          echo "=== ESLint Check ==="
          npm run lint || true
      
      - name: Security scan
        run: |
          echo "=== Python Security Scan ==="
          bandit -r core/ sabor_con_flow/ -f json || true
          safety check --json || true

  # Comprehensive test suite
  test-matrix:
    name: Test Suite
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    needs: [code-quality]
    
    strategy:
      fail-fast: false
      matrix:
        test-suite:
          - name: "Unit Tests"
            command: "pytest core/tests/ -m 'unit or not integration' --cov=core --cov-report=xml --cov-report=term-missing"
            coverage: true
          - name: "Integration Tests" 
            command: "pytest core/tests/ -m 'integration' --cov=core --cov-report=xml --cov-report=term-missing"
            coverage: true
          - name: "Security Tests"
            command: "pytest core/tests/ -m 'security' -v"
            coverage: false
          - name: "Performance Tests"
            command: "pytest core/tests/ -m 'performance' -v"
            coverage: false
    
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Create test environment
        run: |
          cat > .env << EOF
          DJANGO_DEBUG=True
          DJANGO_SECRET_KEY=test-secret-key-for-ci
          DATABASE_URL=sqlite:///test_db.sqlite3
          REDIS_URL=redis://localhost:6379/0
          TURSO_DATABASE_URL=libsql://test.sqlite
          TURSO_AUTH_TOKEN=test-token
          EOF
      
      - name: Run migrations
        run: |
          python manage.py migrate --noinput
      
      - name: Run ${{ matrix.test-suite.name }}
        run: ${{ matrix.test-suite.command }}
      
      - name: Upload coverage to Codecov
        if: matrix.test-suite.coverage == true
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: ${{ matrix.test-suite.name }}
          name: ${{ matrix.test-suite.name }}
          fail_ci_if_error: false

  # Frontend testing
  frontend-tests:
    name: Frontend Tests
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run JavaScript tests
        run: npm test
      
      - name: Build production assets
        run: npm run build
      
      - name: Run accessibility tests
        run: npm run accessibility:audit || true
      
      - name: Performance budget check
        run: node build-scripts/performance-budget.js || true

  # Build verification
  build-check:
    name: Build Verification
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    needs: [code-quality]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          npm ci
      
      - name: Build assets
        run: |
          echo "=== Building CSS and JS Assets ==="
          npm run build
          
          echo "=== Collecting Django Static Files ==="
          python manage.py collectstatic --noinput
      
      - name: Verify build artifacts
        run: |
          echo "=== Verifying Build Artifacts ==="
          
          # Check critical files exist
          test -f staticfiles/css/styles.css || (echo "Missing styles.css" && exit 1)
          
          # Check for webpack-generated JS files (with content hash)
          JS_FILES=$(ls static/js/main.*.js 2>/dev/null | head -1)
          if [ -z "$JS_FILES" ]; then
            # Fallback to non-versioned file
            test -f staticfiles/js/main.js || (echo "Missing main.js" && exit 1)
            JS_FILE="staticfiles/js/main.js"
          else
            JS_FILE="$JS_FILES"
          fi
          
          # Check file sizes are reasonable
          CSS_SIZE=$(stat -c%s staticfiles/css/styles.css 2>/dev/null || stat -f%z staticfiles/css/styles.css)
          JS_SIZE=$(stat -c%s "$JS_FILE" 2>/dev/null || stat -f%z "$JS_FILE")
          
          echo "CSS size: $CSS_SIZE bytes"
          echo "JS size: $JS_SIZE bytes"
          
          # Warn if files are too large
          if [ $CSS_SIZE -gt 102400 ]; then  # 100KB
            echo "WARNING: CSS file larger than 100KB"
          fi
          
          if [ $JS_SIZE -gt 512000 ]; then  # 500KB
            echo "WARNING: JS file larger than 500KB"
          fi

  # Database migration check
  migration-check:
    name: Migration Safety Check
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Set up environment
        run: |
          cat > .env << EOF
          DJANGO_DEBUG=True
          DJANGO_SECRET_KEY=test-secret-key-for-ci
          DATABASE_URL=sqlite:///test_db.sqlite3
          TURSO_DATABASE_URL=libsql://test.sqlite
          TURSO_AUTH_TOKEN=test-token
          EOF
      
      - name: Check for new migrations
        run: |
          echo "=== Checking for Migration Issues ==="
          
          # Check if migrations are needed
          python manage.py makemigrations --check --dry-run || true
          
          # Verify migrations can be applied
          python manage.py migrate --dry-run || true
          
          echo "Migration check passed"

  # PR Summary
  pr-summary:
    name: PR Test Summary
    runs-on: ubuntu-latest
    needs: [code-quality, test-matrix, frontend-tests, build-check, migration-check]
    if: always() && github.event.pull_request.draft == false
    
    steps:
      - name: Generate test summary
        uses: actions/github-script@v7
        with:
          script: |
            const results = {
              'code-quality': '${{ needs.code-quality.result }}',
              'test-matrix': '${{ needs.test-matrix.result }}',
              'frontend-tests': '${{ needs.frontend-tests.result }}',
              'build-check': '${{ needs.build-check.result }}',
              'migration-check': '${{ needs.migration-check.result }}'
            };
            
            const passed = Object.values(results).filter(r => r === 'success').length;
            const failed = Object.values(results).filter(r => r === 'failure').length;
            const skipped = Object.values(results).filter(r => r === 'skipped').length;
            
            const emoji = failed > 0 ? 'âŒ' : passed === Object.keys(results).length ? 'âœ…' : 'âš ï¸';
            
            const summary = `
            ## ${emoji} Test Results Summary
            
            **Passed:** ${passed} | **Failed:** ${failed} | **Skipped:** ${skipped}
            
            | Check | Status |
            |-------|--------|
            | Code Quality | ${results['code-quality'] === 'success' ? 'âœ…' : 'âŒ'} |
            | Test Suite | ${results['test-matrix'] === 'success' ? 'âœ…' : 'âŒ'} |
            | Frontend Tests | ${results['frontend-tests'] === 'success' ? 'âœ…' : 'âŒ'} |
            | Build Verification | ${results['build-check'] === 'success' ? 'âœ…' : 'âŒ'} |
            | Migration Check | ${results['migration-check'] === 'success' ? 'âœ…' : 'âŒ'} |
            
            ${failed > 0 ? 'ğŸ” **Please check the failed jobs and fix issues before merging.**' : 'ğŸ‰ **All checks passed! Ready for review.**'}
            `;
            
            // Add comment to PR
            if (context.payload.pull_request) {
              await github.rest.issues.createComment({
                issue_number: context.payload.pull_request.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: summary
              });
            }
            
            // Set step summary
            core.summary.addRaw(summary);
            await core.summary.write();
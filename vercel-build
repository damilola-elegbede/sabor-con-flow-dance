#!/bin/bash
set -e

echo "Installing Node.js dependencies..."
npm ci

echo "Building assets with Vite..."
npm run build

# Copy Vite manifest to non-hidden directory so collectstatic includes it
# Django's collectstatic ignores hidden directories like .vite/
echo "Copying Vite manifest..."
mkdir -p static/dist/vite-manifest
cp static/dist/.vite/manifest.json static/dist/vite-manifest/manifest.json

# Generate Python module with manifest data for serverless function
# This ensures the manifest is bundled with the Python code
echo "Generating manifest Python module..."
python -c "
import json

with open('static/dist/.vite/manifest.json', 'r') as f:
    manifest = json.load(f)

with open('core/vite_manifest_data.py', 'w') as f:
    f.write('# Auto-generated by vercel-build - DO NOT EDIT\n')
    f.write('# This file contains the Vite manifest for production builds\n')
    f.write('MANIFEST = ')
    f.write(repr(manifest))
    f.write('\n')

print('Generated core/vite_manifest_data.py')
"

echo "Installing Python dependencies..."
pip install -r requirements.txt

echo "Collecting static files..."
python manage.py collectstatic --noinput

echo "Build completed successfully!" 